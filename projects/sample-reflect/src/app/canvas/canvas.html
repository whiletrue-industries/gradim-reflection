<div 
  class="canvas-container"
  (click)="onCanvasClick($event)"
  (mousedown)="onCanvasMouseDown($event)"
  (drop)="onDrop($event)"
  (dragover)="onDragOver($event)"
>
  <div class="dot-grid" [ngStyle]="getDotGridStyle()"></div>
  
  <div class="canvas-objects" [ngStyle]="getCanvasObjectsStyle()">
    @for (obj of objects(); track obj.id) {
               <div 
                    class="canvas-object"
                    [class.selected]="selectedObjectId() === obj.id"
                    [ngStyle]="getObjectStyle(obj)"
                    (click)="onObjectClick($event, obj.id)"
                                                  (mousedown)="onObjectMouseDown($event, obj.id)"
               >
                    <div class="hover-border" [ngStyle]="getSelectionBorderStyle()"></div>
        @if (obj.type === 'image') {
          <img [src]="obj.content" alt="Canvas image" class="object-content" />
        } @else if (obj.type === 'iframe') {
          @if (obj.displayMode === 'iframe' || !obj.ogImage) {
            <iframe 
              [src]="obj.safeUrl || obj.content" 
              class="object-content"
                                scrolling="no"
              sandbox="allow-scripts allow-same-origin allow-forms"
                                (load)="onIframeLoad($event, obj.id)"
            ></iframe>
          } @else {
            <img [src]="obj.ogImage" alt="URL preview" class="object-content" />
          }
        }
        
        @if (selectedObjectId() === obj.id) {
          <!-- Toggle button for iframe objects with og:image -->
          @if (obj.type === 'iframe' && obj.ogImage) {
            <div class="display-mode-toggle" [ngStyle]="getInverseScaleStyle(obj)">
              <button 
                class="toggle-btn"
                [class.active]="obj.displayMode === 'iframe'"
                (click)="toggleDisplayMode(obj.id)"
                title="Show as iframe"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm15 2h-4v3h4V4zm0 4h-4v3h4V8zm0 4h-4v3h3a1 1 0 0 0 1-1v-2zm-5 3v-3H6v3h4zm-5 0v-3H1v2a1 1 0 0 0 1 1h3zm-4-4h4V8H1v3zm0-4h4V4H1v3zm5-3v3h4V4H6zm4 4H6v3h4V8z"/>
                </svg>
              </button>
              <button 
                class="toggle-btn"
                [class.active]="obj.displayMode === 'image'"
                (click)="toggleDisplayMode(obj.id)"
                title="Show as image"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                  <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                </svg>
              </button>
            </div>
          }
          
          <!-- Edges (1px when selected, 3px when hovered) -->
          <div class="selection-border" [ngStyle]="getSelectionBorderStyle()"></div>
          
          <!-- Corner handles -->
          <div class="handle handle-corner handle-nw" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-nw')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-nw')"></div>
          <div class="handle handle-corner handle-ne" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-ne')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-ne')"></div>
          <div class="handle handle-corner handle-sw" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-sw')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-sw')"></div>
          <div class="handle handle-corner handle-se" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-se')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-se')"></div>
          
          <!-- Edge handles for width scaling -->
          <div class="handle handle-edge handle-w" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-w')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-w')"></div>
          <div class="handle handle-edge handle-e" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-e')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-e')"></div>
          
          <!-- Edge handles for height scaling -->
          <div class="handle handle-edge handle-n" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-n')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-n')"></div>
          <div class="handle handle-edge handle-s" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-s')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-s')"></div>
          
          <!-- Rotation indicator (outside corners) -->
          <div class="rotation-indicator rotation-nw" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getRotateCursor(obj, 'nw')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'rotate-nw')"></div>
          <div class="rotation-indicator rotation-ne" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getRotateCursor(obj, 'ne')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'rotate-ne')"></div>
          <div class="rotation-indicator rotation-sw" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getRotateCursor(obj, 'sw')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'rotate-sw')"></div>
          <div class="rotation-indicator rotation-se" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getRotateCursor(obj, 'se')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'rotate-se')"></div>
        }
      </div>
    }
  </div>
  
  <div class="zoom-controls">
    <div class="zoom-counter">{{ zoomPercentage() }}%</div>
    <button class="zoom-reset" (click)="resetZoom()">Reset</button>
  </div>
  
  <div class="canvas-instructions">
    <p>Drag and drop images here • Paste URLs (Ctrl/Cmd+V) • Drag canvas to pan • Scroll to zoom</p>
  </div>
</div>
