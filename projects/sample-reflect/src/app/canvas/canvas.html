<div 
  class="canvas-container"
  (click)="onCanvasClick($event)"
  (mousedown)="onCanvasMouseDown($event)"
  (touchstart)="onCanvasTouchStart($event)"
  (drop)="onDrop($event)"
  (dragover)="onDragOver($event)"
>
  <div class="dot-grid" [ngStyle]="getDotGridStyle()"></div>
  
  <div class="canvas-objects" [ngStyle]="getCanvasObjectsStyle()">
    @for (obj of objects(); track obj.id) {
               <div 
                    class="canvas-object"
                    [class.selected]="selectedObjectId() === obj.id"
                    [ngStyle]="getObjectStyle(obj)"
                    (click)="onObjectClick($event, obj.id)"
                    (mousedown)="onObjectMouseDown($event, obj.id)"
                    (touchstart)="onObjectTouchStart($event, obj.id)"
               >
                    <div class="hover-border" [ngStyle]="getSelectionBorderStyle()"></div>
        @if (obj.isEmptyFrame) {
          <!-- Empty polaroid frame button with image upload -->
          <div 
            class="empty-frame-button"
            (click)="fileInput.click(); $event.stopPropagation()"
            (touchstart)="fileInput.click(); $event.stopPropagation()"
          >
            <div class="plus-icon-center">+</div>
            <input 
              type="file" 
              accept="image/*"
              (change)="onEmptyFrameUpload($event, obj.id)"
              #fileInput
              hidden
            />
          </div>
        } @else if (obj.type === 'image') {
          <!-- Use normal src for data/base64 images; NgOptimizedImage is not suitable here -->
          <img [src]="obj.content" alt="Canvas image" class="object-content" (load)="onUserImageLoad($event, obj.id)" />
        } @else if (obj.type === 'iframe') {
            <!-- Show og:image preview when in image mode -->
            <img [src]="obj.ogImage" alt="URL preview" class="object-content" (load)="onOgImageLoad($event, obj.id)" />
          } @else {
            <!-- Show iframe with interaction overlay when in iframe mode -->
            <div 
              class="iframe-wrapper"
              (mouseenter)="onIframeMouseEnter(obj.id)"
              (mouseleave)="onIframeMouseLeave(obj.id)"
            >
              <iframe 
                [src]="obj.safeUrl || obj.content" 
                class="object-content"
                [class.dimmed]="hoveredIframeId() === obj.id"
                [class.interactive]="interactiveIframeId() === obj.id"
                [attr.scrolling]="interactiveIframeId() === obj.id ? 'yes' : 'no'"
                sandbox="allow-scripts allow-forms"
                (load)="onIframeLoad($event, obj.id)"
              ></iframe>
              @if (hoveredIframeId() === obj.id && interactiveIframeId() !== obj.id) {
                <div 
                  class="iframe-overlay"
                  (click)="onIframeOverlayClick($event, obj.id)"
                >
                  <div class="iframe-overlay-message">
                    Click to interact
                  </div>
                </div>
              }
            </div>
          }
        
        @if (selectedObjectId() === obj.id) {
          <!-- Toggle button for iframe objects with og:image -->
          @if (obj.type === 'iframe' && obj.ogImage) {
            <div class="display-mode-toggle" [ngStyle]="getInverseScaleStyle(obj)">
              <button 
                class="toggle-btn"
                [class.active]="obj.displayMode === 'image'"
                (click)="toggleDisplayMode(obj.id)"
                title="Show as image"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                  <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                </svg>
              </button>
              <button 
                class="toggle-btn"
                [class.active]="obj.displayMode === 'iframe'"
                (click)="toggleDisplayMode(obj.id)"
                title="Show as website"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm7.5-6.923c-.67.204-1.335.82-1.887 1.855A7.97 7.97 0 0 0 5.145 4H7.5V1.077zM4.09 4a9.267 9.267 0 0 1 .64-1.539 6.7 6.7 0 0 1 .597-.933A7.025 7.025 0 0 0 2.255 4H4.09zm-.582 3.5c.03-.877.138-1.718.312-2.5H1.674a6.958 6.958 0 0 0-.656 2.5h2.49zM4.847 5a12.5 12.5 0 0 0-.338 2.5H7.5V5H4.847zM8.5 5v2.5h2.99a12.495 12.495 0 0 0-.337-2.5H8.5zM4.51 8.5a12.5 12.5 0 0 0 .337 2.5H7.5V8.5H4.51zm3.99 0V11h2.653c.187-.765.306-1.608.338-2.5H8.5zM5.145 12c.138.386.295.744.468 1.068.552 1.035 1.218 1.65 1.887 1.855V12H5.145zm.182 2.472a6.696 6.696 0 0 1-.597-.933A9.268 9.268 0 0 1 4.09 12H2.255a7.024 7.024 0 0 0 3.072 2.472zM3.82 11a13.652 13.652 0 0 1-.312-2.5h-2.49c.062.89.291 1.733.656 2.5H3.82zm6.853 3.472A7.024 7.024 0 0 0 13.745 12H11.91a9.27 9.27 0 0 1-.64 1.539 6.688 6.688 0 0 1-.597.933zM8.5 12v2.923c.67-.204 1.335-.82 1.887-1.855.173-.324.33-.682.468-1.068H8.5zm3.68-1h2.146c.365-.767.594-1.61.656-2.5h-2.49a13.65 13.65 0 0 1-.312 2.5zm2.802-3.5a6.959 6.959 0 0 0-.656-2.5H12.18c.174.782.282 1.623.312 2.5h2.49zM11.27 2.461c.247.464.462.98.64 1.539h1.835a7.024 7.024 0 0 0-3.072-2.472c.218.284.418.598.597.933zM10.855 4a7.966 7.966 0 0 0-.468-1.068C9.835 1.897 9.17 1.282 8.5 1.077V4h2.355z"/>
                </svg>
              </button>
            </div>
          }
          
          <!-- Edges (1px when selected, 3px when hovered) -->
          <div class="selection-border" [ngStyle]="getSelectionBorderStyle()"></div>
          
          <!-- Corner handles -->
          <div class="handle handle-corner handle-nw" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-nw')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-nw')"
               (touchstart)="onHandleTouchStart($event, obj.id, 'scale-nw')"></div>
          <div class="handle handle-corner handle-ne" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-ne')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-ne')"
               (touchstart)="onHandleTouchStart($event, obj.id, 'scale-ne')"></div>
          <div class="handle handle-corner handle-sw" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-sw')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-sw')"
               (touchstart)="onHandleTouchStart($event, obj.id, 'scale-sw')"></div>
          <div class="handle handle-corner handle-se" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-se')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-se')"
               (touchstart)="onHandleTouchStart($event, obj.id, 'scale-se')"></div>
          
          <!-- Edge handles for width scaling -->
          <div class="handle handle-edge handle-w" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-w')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-w')"
               (touchstart)="onHandleTouchStart($event, obj.id, 'scale-w')"></div>
          <div class="handle handle-edge handle-e" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-e')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-e')"
               (touchstart)="onHandleTouchStart($event, obj.id, 'scale-e')"></div>
          
          <!-- Edge handles for height scaling -->
          <div class="handle handle-edge handle-n" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-n')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-n')"
               (touchstart)="onHandleTouchStart($event, obj.id, 'scale-n')"></div>
          <div class="handle handle-edge handle-s" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getCursorForHandle(obj, 'scale-s')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'scale-s')"
               (touchstart)="onHandleTouchStart($event, obj.id, 'scale-s')"></div>
          
          <!-- Rotation indicator (outside corners) -->
          <div class="rotation-indicator rotation-nw" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getRotateCursor(obj, 'nw')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'rotate-nw')"
               (touchstart)="onHandleTouchStart($event, obj.id, 'rotate-nw')"></div>
          <div class="rotation-indicator rotation-ne" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getRotateCursor(obj, 'ne')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'rotate-ne')"
               (touchstart)="onHandleTouchStart($event, obj.id, 'rotate-ne')"></div>
          <div class="rotation-indicator rotation-sw" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getRotateCursor(obj, 'sw')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'rotate-sw')"
               (touchstart)="onHandleTouchStart($event, obj.id, 'rotate-sw')"></div>
          <div class="rotation-indicator rotation-se" 
               [ngStyle]="getInverseScaleStyle(obj)"
               [style.cursor]="getRotateCursor(obj, 'se')"
               (mousedown)="onHandleMouseDown($event, obj.id, 'rotate-se')"
               (touchstart)="onHandleTouchStart($event, obj.id, 'rotate-se')"></div>
        }
      </div>
    }
  </div>
  
  <!-- Close button to return to URL wrapper (only shown when came from URL wrapper) -->
  @if (cameFromUrlWrapper()) {
    <div class="close-button-container">
      <button class="close-button" (click)="returnToUrlWrapper()" title="Return to URL wrapper">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M15 10l-1.5-1.5L9 13V3H7v10L2.5 8.5 1 10l6 6z"/>
        </svg>
      </button>
    </div>
  }

  <!-- Shuffle button (top right) -->
  <div class="shuffle-button-container">
    <button class="shuffle-button" (click)="shuffleImage()" title="Shuffle image" [disabled]="isShuffling()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 14L22 18L18 22M18 2L22 6L18 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M2 18.0001H3.973C4.61949 18.0045 5.25742 17.8522 5.83215 17.5561C6.40687 17.26 6.90127 16.829 7.273 16.3001L12.727 7.7001C13.0987 7.17114 13.5931 6.74018 14.1679 6.44411C14.7426 6.14803 15.3805 5.99568 16.027 6.0001H22M2 6.0001H3.972C4.71746 5.99491 5.44954 6.19814 6.08564 6.58687C6.72174 6.9756 7.23655 7.53436 7.572 8.2001M22 18.0001H15.959C15.3036 17.9934 14.6598 17.8258 14.0844 17.5119C13.509 17.198 13.0195 16.7475 12.659 16.2001L12.3 15.7501" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
  
  <div class="zoom-controls">
    <div class="zoom-counter">{{ zoomPercentage() }}%</div>
    <button class="zoom-reset" (click)="fitToView()" title="Fit to view">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"/>
      </svg>
    </button>
  </div>
  

  
  <div class="canvas-instructions">
    <p>{{ instructionsText() }}</p>
  </div>
  
  <!-- URL input modal -->
  @if (showUrlModal()) {
    <div class="url-modal-overlay" (click)="cancelUrlModal()">
      <div class="url-modal" (click)="$event.stopPropagation()">
        <h3>Add URL</h3>
        <input
          #urlInput
          type="url"
          class="url-input"
          placeholder="Paste URL here..."
          [value]="urlInputValue()"
          (input)="urlInputValue.set(urlInput.value)"
          (keydown.enter)="submitUrlModal()"
          (keydown.escape)="cancelUrlModal()"
        />
        <div class="url-modal-actions">
          <button class="url-cancel" (click)="cancelUrlModal()">Cancel</button>
          <button class="url-submit" (click)="submitUrlModal()">Add</button>
        </div>
      </div>
    </div>
  }
  
  <!-- Canvas Apps Carousel -->
  <app-canvas-carousel 
    [selectedAppIndex]="selectedAppIndex()"
    (appChanged)="onAppChange($event)"
  />
</div>

<!-- Fixed share menu at bottom (outside canvas) -->
<div class="share-menu-container">
  <div class="share-menu">
    <button 
      class="share-button copy" 
      (click)="shareVia('copy')" 
      title="Copy link"
    >
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M9.16854 14.8294L14.8255 9.17245M7.04654 11.2934L5.63254 12.7074C5.2611 13.0789 4.96645 13.5199 4.76543 14.0052C4.5644 14.4905 4.46094 15.0106 4.46094 15.5359C4.46094 16.0612 4.5644 16.5814 4.76543 17.0667C4.96645 17.552 5.2611 17.993 5.63254 18.3644C6.00398 18.7359 6.44495 19.0305 6.93027 19.2316C7.41558 19.4326 7.93574 19.536 8.46104 19.536C8.98634 19.536 9.5065 19.4326 9.99181 19.2316C10.4771 19.0305 10.9181 18.7359 11.2895 18.3644L12.7015 16.9504M11.2885 7.05045L12.7025 5.63645C13.074 5.265 13.515 4.97036 14.0003 4.76933C14.4856 4.56831 15.0057 4.46484 15.531 4.46484C16.0563 4.46484 16.5765 4.56831 17.0618 4.76933C17.5471 4.97036 17.9881 5.265 18.3595 5.63645C18.731 6.00789 19.0256 6.44886 19.2267 6.93417C19.4277 7.41949 19.5311 7.93965 19.5311 8.46495C19.5311 8.99025 19.4277 9.51041 19.2267 9.99572C19.0256 10.481 18.731 10.922 18.3595 11.2934L16.9455 12.7074" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <button 
      class="share-button upload" 
      (click)="shareVia('upload')" 
      title="Share to..."
    >
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_2892_191191)">
          <path d="M12 5V13.5M15 7L12 4L9 7M5 12V17C5 17.5304 5.21071 18.0391 5.58579 18.4142C5.96086 18.7893 6.46957 19 7 19H17C17.5304 19 18.0391 18.7893 18.4142 18.4142C18.7893 18.0391 19 17.5304 19 17V12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        <defs>
          <clipPath id="clip0_2892_191191">
            <rect width="24" height="24" fill="white"/>
          </clipPath>
        </defs>
      </svg>
    </button>
    <button 
      class="share-button download" 
      (click)="shareVia('download')" 
      title="Download"
    >
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_2892_191188)">
          <path d="M12 5V13.5M12 13.5L15 10.5M12 13.5L9 10.5M5 15V17C5 17.5304 5.21071 18.0391 5.58579 18.4142C5.96086 18.7893 6.46957 19 7 19H17C17.5304 19 18.0391 18.7893 18.4142 18.4142C18.7893 18.0391 19 17.5304 19 17V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        <defs>
          <clipPath id="clip0_2892_191188">
            <rect width="24" height="24" fill="white"/>
          </clipPath>
        </defs>
      </svg>
    </button>
    <button 
      class="share-button whatsapp" 
      (click)="shareVia('whatsapp')" 
      title="Share on WhatsApp"
    >
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_2892_191183)">
          <path d="M22.375 12.0195C22.375 17.5425 17.898 22.0195 12.375 22.0195C10.6195 22.022 8.89463 21.5604 7.375 20.6815L2.375 21.5195L3.207 16.0195C2.65735 14.7577 2.3741 13.3959 2.375 12.0195C2.375 6.49653 6.852 2.01953 12.375 2.01953C17.898 2.01953 22.375 6.49653 22.375 12.0195Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M13.3354 13.8875L15.4154 13.4815L17.3754 14.2345V16.0575C17.3754 16.6645 16.8534 17.1275 16.2654 16.9975C14.7424 16.6635 11.9754 15.8235 10.0534 13.8875C8.22337 12.0445 7.59837 9.47753 7.38537 8.06053C7.30037 7.49353 7.74937 7.01953 8.31837 7.01953H10.2124L10.9474 8.98853L10.5584 11.0895" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </g>
        <defs>
          <clipPath id="clip0_2892_191183">
            <rect width="24" height="24" fill="white"/>
          </clipPath>
        </defs>
      </svg>
    </button>
    <button 
      class="share-button instagram" 
      (click)="shareVia('instagram')" 
      title="Share on Instagram"
    >
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.057-1.645.069-4.849.069-3.204 0-3.584-.012-4.849-.069-3.259-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zM5.838 12a6.162 6.162 0 1 1 12.324 0 6.162 6.162 0 0 1-12.324 0zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm4.965-10.322a1.44 1.44 0 1 1 2.881.001 1.44 1.44 0 0 1-2.881-.001z"/>
      </svg>
    </button>
  </div>
</div>
